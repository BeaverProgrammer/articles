# JavaScript 闭包

闭包（closure), 是 JavaScript 的重要概念，要理解它其实需要理解很多 JavaScript 的基础知识。

## 什么是闭包

简言之，闭包是引用了外部变量的函数。

按我的理解，还有另两种意思：

1. 闭包是函数，函数是闭包。
2. 闭包是内外层函数的结构。

当你了解了函数, 记住上面的粗略定义其实就了解了闭包。

如果你还没有很好的理解作用域链和执行环境的话，可能还不能算理解了闭包。

## 什么是作用域链

### 值、变量和作用域

值就是内存当中的数据。我这里不打算详列 JavaScript 的两大类N小类值。

变量就是对值的引用，我这里也用以指对象属性。

作用域就是变量的活动范围、作用范围，或者理解为变量被识别的范围。

### 局部作用域和全局作用域

局部作用域有函数作用域和块级作用域，后者是 ES6 新增的。

非局部作用域就是全局作用域。

### 初识作用域链

作用域链，是变量活动范围的扩展 , 是局部作用域指向全局作用域的单向引用。

就是说，全局作用域或外层作用域（嵌套函数）中的变量的活动范围自动扩展到局部作用域，反之不然。

```js
// 1. 单向引用
var a = 10;

function test() {
    console.log(a);
}

test();     // 10

// 2. 反之不然
function test() {
    var a = 10;
}

test();
console.log(a);     // ReferenceError
```

这里可能有人提出意见，说下面的是个反例：

```js
var a;

function test() {
    var b = 10;
    a = b;
}

test();
console.log(a);     // 10
```

其实不然，主要还是没搞懂值和变量的区别。这个所谓的“反例”实际做的只是对 10 这个值的引用，而不是变量 b 的引用，对这个例子扩展一下就清楚了：
```
console.log(b);     // ReferenceError
```

## 执行环境

JavaScript 是单线程的执行环境。

程序运行后调用函数前，是在主执行环境或者全局环境中。调用函数时，离开全局环境进入临时创建的函数执行环境，当函数执行完毕后又返回到全局环境（或上一执行环境中，嵌套函数）。

### 变量对象

经常，我们谈到全局环境的时候，我们指的是全局对象，浏览器中是 window 而 nodejs 是global。粗略地，全局对象可以看成全局环境对应的变量对象。

变量对象是一个隐式的 JS 引擎创建的对象，它的属性包含了对应执行环境的局部变量。我们并不能直接操作变量对象。

通常地，函数执行完毕表示它对应的执行环境结束，返回到前一执行环境，同时它对应的变量对象也被删除。但如果这个变量对象或其属性被之前执行环境的变量所引用，那么这个变量对象就不会被删除，除非引用这个变量对象的变量或属性被删除或所处执行环境退出。

```js
function outer() {
    var a = 1;
    function inner() {
        console.log(a);
    }
    return inner;
}
var closure = outer();
inner();    // 1
```

### 再识作用域链

通过变量对象的概念理解作用域链。

如果理解了对象的原型链，再通过变量对象的概念理解作用域链是值得的。

通常，对象有 __proto__ 属性指向它的原型对象，将 __proto__ 理解成一个隐式的内部的属性也可。同样的，可以将局部作用域/局部执行环境的局部变量理解成变量对象的自有属性，而一个类似 outer 的属性指向外部环境，注意 outer 是我杜撰的，也许 ECMAScript 有官样的词汇。

当变量对象的非自有变量（全局变量或外部变量）出现在了对应的执行环境中，JS 引擎会试着到 outer 去追寻这个变量，从这个角度来看，作用域链其实是原型链。

## 真正地理解闭包

理解了上面的这一些概念，是时候真正地理解闭包了。

闭包（closure), 字面上其实就是 闭合/包围/关闭/封闭/封装。

由于函数的局部作用域，闭包（外部函数）具有隐藏变量的效果。

由于作用域链，闭包（内部函数）具有访问这些隐藏变量的能力。

将闭包（内部函数）赋值给更外部的变量，也就是将闭包（外部函数）的变量对象被引用到更外层的执行环境中，使得闭包（外部函数）执行完毕执行环境返回后，其变量对象（被隐藏的变量和被引用的内部函数）仍存在于内存中。

这就是闭包。

本质上，闭包是一个较高层次的抽象概念, 或者，函数应用的一种模式。
